### Build OpenRC ###

set -o errexit
set -o nounset
set -o pipefail

OPENRC_VERS=0.21.3

fetch() {
  cd "${_3RDPARTY}/MIT/openrc/src"
  if [ ! -e "${_3RDPARTY}/MIT/openrc/src/openrc-${OPENRC_VERS}.tar.gz" ]; then
      curl -L -o openrc-${OPENRC_VERS}.tar.gz https://github.com/OpenRC/openrc/archive/${OPENRC_VERS}.tar.gz
  fi
}

prepare() {

  tar -C "${SRCROOT}" -xf openrc-${OPENRC_VERS}.tar.gz
  cd "${SRCROOT}/openrc-${OPENRC_VERS}"

  for i in "${_3RDPARTY}"/MIT/openrc/patches/*.patch; do
      patch -p1 --input="${i}"
  done

  sed -i -e '/^sed/d' pkgconfig/Makefile
}

build() {
  return
}

install() {
  cd "${SRCROOT}/openrc-${OPENRC_VERS}"

  make -j${NUM_CPU} install \
    LIBNAME=lib \
    DESTDIR="${INSTALLROOT}" \
    MKNET=yes \
    MKPKGCONFIG=no \
    MKSTATICLIBS=no \
    MKTOOLS=yes \
    LOCAL_PREFIX=/usr/local \
    BRANDING=\"Warewulf/$(uname -s)\" \
    CC=musl-gcc
}
