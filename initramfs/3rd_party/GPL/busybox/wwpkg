### Build Busybox (static) ###

set -o errexit
set -o nounset
set -o pipefail

BUSYBOX_VERS=1.25.0

fetch() {
  cd "${_3RDPARTY}/GPL/busybox/src"

  if [ ! -e "${_3RDPARTY}/GPL/busybox/src/busybox-${BUSYBOX_VERS}.tar.bz2" ]; then
      curl -O https://www.busybox.net/downloads/busybox-${BUSYBOX_VERS}.tar.bz2
  fi
}

prepare() {

  # Where to find linux-headers
  KERN_HDR=/usr/include

  # TODO: Using linux-headers from the buildhost for now
  mkdir -p "${BUILDROOT}/include"
  cd "${BUILDROOT}/include"
  ln -s "${KERN_HDR}/linux" linux
  ln -s "${KERN_HDR}/mtd" mtd
  if [ -d "${KERN_HDR}/asm" ]
  then
    ln -s "${KERN_HDR}/asm" asm
  else
      ln -s "${KERN_HDR}/asm-generic" asm
  fi
  ln -s "${KERN_HDR}/asm-generic" asm-generic

  tar -C "${SRCROOT}" -xf "${_3RDPARTY}/GPL/busybox/src/busybox-${BUSYBOX_VERS}.tar.bz2"

  cd "${SRCROOT}/busybox-${BUSYBOX_VERS}"
  cp "${_3RDPARTY}/GPL/busybox/src/busybox.config" .config
  sed -i -e "s|.*CONFIG_PREFIX.*|CONFIG_PREFIX=\"${INSTALLROOT}\"|" .config
}

build() {
  cd "${SRCROOT}/busybox-${BUSYBOX_VERS}"
  make V=1 -j${NUM_CPU}
}

install() {
  make install
  (cd "${INSTALLROOT}" && ln -s bin/busybox init)
}
